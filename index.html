<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PugHall | Admin Dashboard</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e74c3c">

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
:root{
--bg:#1a1512;
--accent:#e67e22;
--pug-tan:#d2b48c;
--card:rgba(30, 24, 20, 0.85);
--border:#3e2f26;
--gold:#f1c40f;
--red:#e74c3c;
--green:#2ecc71;
--font-title: 'Fredoka', sans-serif;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
    margin:0;
    font-family:Inter,sans-serif;
    background:var(--bg);
    color:#fff;
    min-height:100vh;
}

body::before{
    content:"";
    position:fixed;
    inset:0;
    background:url('https://i.imgur.com/rM43tnX.jpeg') center/cover;
    opacity:.15;
    z-index:-1;
}

header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:15px 30px;
    background:rgba(26,21,18,.95);
    backdrop-filter:blur(15px);
    border-bottom:3px solid var(--red);
    position:sticky;
    top:0;
    z-index:100;
}

.logo{
    font-family:var(--font-title);
    font-size:1.8rem;
    font-weight:700;
    color:var(--red);
    display:flex;
    gap:8px;
    align-items:center;
}
.logo span{color:#fff}

.main{padding:40px;max-width:1400px;margin:auto}
.section-title{
    font-family:var(--font-title);
    font-size:1.5rem;
    margin-bottom:20px;
    display:flex;
    gap:10px;
    color:var(--pug-tan);
}

.grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
    gap:25px;
}

.card{
    background:var(--card);
    border-radius:20px;
    overflow:hidden;
    border:2px solid var(--border);
    transition:.3s;
    display:flex;
    flex-direction:column;
}
.card:hover{transform:translateY(-5px);border-color:var(--accent)}

.card-media img{width:100%;height:180px;object-fit:cover}

.card-body{
    padding:15px;
    display:flex;
    flex-direction:column;
    gap:8px;
    flex:1;
}

.card-title{font-weight:900;text-transform:uppercase}
.card-meta{font-size:12px;opacity:.7;color:var(--pug-tan);display:flex;gap:8px}

.admin-actions{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    padding:15px;
    background:rgba(0,0,0,.2);
}

.btn{
    border:none;
    padding:12px;
    border-radius:8px;
    font-weight:800;
    cursor:pointer;
    display:flex;
    justify-content:center;
    align-items:center;
    gap:8px;
    color:#fff;
}
.btn:hover{transform:scale(1.05)}
.btn-approve{background:var(--green);color:#000}
.btn-reject{background:var(--red)}
.btn-preview{background:#333}

.player{
    position:fixed;
    inset:0;
    background:#050403;
    display:none;
    flex-direction:column;
    z-index:2000;
}
.player-header{
    padding:10px 20px;
    background:#111;
    display:flex;
    justify-content:space-between;
    align-items:center;
}
iframe{width:100%;flex:1;border:none}
.empty-state{text-align:center;padding:50px;opacity:.5}
</style>
</head>

<body>

<header>
    <div class="logo"><i data-lucide="shield-alert"></i> PUG<span>ADMIN</span></div>
    <button class="btn" id="btn-notify" style="background:#333" onclick="enableNotifications()">
        <i data-lucide="bell"></i> ATIVAR NOTIFICAÃ‡Ã•ES
    </button>
</header>

<div class="main">
    <h2 class="section-title"><i data-lucide="list-checks"></i> FILA DE APROVAÃ‡ÃƒO</h2>
    <div id="list" class="grid">
        <div class="empty-state">Carregando fila...</div>
    </div>
</div>

<div class="player" id="player">
    <div class="player-header">
        <span id="gameTitle">TESTANDO...</span>
        <button class="btn btn-reject" onclick="closeGame()">FECHAR</button>
    </div>
    <iframe id="frame"></iframe>
</div>

<script>
/* ===== SERVICE WORKER (PWA) ===== */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./service-worker.js')
        .then(() => console.log('âœ… Service Worker registrado'))
        .catch(err => console.error('âŒ SW erro', err));
}

/* ===== APP ===== */
const barkSound = new Audio('https://www.myinstants.com/media/sounds/dog-bark.mp3');
const _0xgh = s => atob(s);

firebase.initializeApp({
  apiKey:_0xgh("QUl6YVN5Q2hQUkpYQS1xTlpCVk02b29FY2pVYkI3OXhSVzFYTkFN"),
  authDomain:_0xgh("b255eGNoYXQtOGFkNmYuZmlyZWJhc2VhcHAuY29t"),
  projectId:_0xgh("b255eGNoYXQtOGFkNmY="),
});

const db = firebase.firestore();
let isFirstLoad = true;

function enableNotifications(){
    Notification.requestPermission().then(p=>{
        if(p==="granted"){
            barkSound.play();
            updateNotifyBtn();
        }
    });
}

function updateNotifyBtn(){
    const b=document.getElementById('btn-notify');
    b.style.background="var(--green)";
    b.style.color="#000";
    b.innerHTML='<i data-lucide="bell-ring"></i> NOTIFICAÃ‡Ã•ES ATIVAS';
    lucide.createIcons();
}

function notifyNewGame(title,author,img){
    if(Notification.permission==="granted"){
        barkSound.play().catch(()=>{});
        new Notification("ðŸš¨ NOVO JOGO!",{
            body:`${title} por ${author}`,
            icon:img||'https://i.imgur.com/rM43tnX.jpeg'
        });
    }
}

db.collection("games").where("published","==",false).onSnapshot(snap=>{
    if(!isFirstLoad){
        snap.docChanges().forEach(c=>{
            if(c.type==="added"){
                const d=c.doc.data();
                notifyNewGame(d.title,d.author,d.img);
            }
        });
    }

    const list=document.getElementById('list');
    list.innerHTML="";
    if(snap.empty){
        list.innerHTML='<div class="empty-state">Tudo limpo ðŸ˜Ž</div>';
        isFirstLoad=false;
        return;
    }

    snap.forEach(doc=>{
        const g=doc.data();
        list.innerHTML+=`
        <div class="card">
            <div class="card-media"><img src="${g.img}"></div>
            <div class="card-body">
                <div class="card-title">${g.title}</div>
                <div class="card-meta">${g.author}</div>
                <button class="btn btn-preview" onclick="openPreview('${g.url}','${g.title}')">TESTAR</button>
            </div>
            <div class="admin-actions">
                <button class="btn btn-reject" onclick="reject('${doc.id}')">LIXO</button>
                <button class="btn btn-approve" onclick="approve('${doc.id}')">APROVAR</button>
            </div>
        </div>`;
    });
    lucide.createIcons();
    isFirstLoad=false;
});

function approve(id){db.collection("games").doc(id).update({published:true})}
function reject(id){db.collection("games").doc(id).delete()}
function openPreview(u,t){
    player.style.display="flex";
    frame.src=u;
    gameTitle.innerText=t;
}
function closeGame(){
    player.style.display="none";
    frame.src="";
}

if(Notification.permission==="granted") updateNotifyBtn();
</script>

</body>
</html>
