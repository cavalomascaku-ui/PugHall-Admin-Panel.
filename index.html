<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PugHall | Admin Dashboard</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#e74c3c">

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://unpkg.com/lucide@latest"></script>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<style>
:root{
--bg:#0f0f13;
--accent:#ff9f43;
--pug-tan:#d2b48c;
--card:#1d1d25;
--border:#2d2d3a;
--gold:#feca57;
--red:#ff6b6b;
--green:#1dd1a1;
--font-title: 'Fredoka', sans-serif;
--font-body: 'Inter', sans-serif;
--shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}

body{
    margin:0;
    font-family:var(--font-body);
    background:var(--bg);
    color:#ecf0f1;
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
}

/* Background Fofo com Opacidade */
body::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('https://i.imgur.com/rM43tnX.jpeg');
    background-size: cover;
    background-position: center;
    opacity: 0.05;
    filter: blur(3px) grayscale(0.5);
    z-index: -1;
    pointer-events: none;
}

header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:20px 40px;
    background:rgba(15, 15, 19, 0.85);
    backdrop-filter: blur(20px);
    border-bottom:1px solid var(--border);
    position:sticky;
    top:0;
    z-index:100;
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}

.logo{
    font-family: var(--font-title);
    font-weight:700;
    font-size:1.8rem;
    color:var(--red);
    display: flex;
    align-items: center;
    gap: 8px;
}
.logo span { color: #fff; }

.main{padding:60px 40px; max-width:1600px; margin:auto;}
.section-title{
    font-family:var(--font-title);
    font-size:2rem;
    margin-bottom:30px;
    display:flex;
    align-items:center;
    gap:15px;
    color: #fff;
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
}
.section-title i { color: var(--accent); }

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:30px;}

.card{
    background:var(--card);
    border-radius:16px;
    overflow:hidden;
    border:1px solid var(--border);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    position: relative;
}
.card:hover{
    transform:translateY(-8px); 
    border-color:var(--accent);
    box-shadow: 0 20px 40px -10px rgba(255, 159, 67, 0.15);
}

.card-media img {width:100%;height:200px;object-fit:cover; transition: transform 0.5s;}
.card:hover .card-media img { transform: scale(1.05); }

.card-body{padding:20px; flex: 1; display: flex; flex-direction: column; gap: 12px;}
.card-title{font-weight:800; text-transform:uppercase; font-size: 1.2rem; letter-spacing: -0.5px;}
.card-meta{font-size:13px; opacity:.8; display:flex; gap:15px; align-items:center; color: var(--pug-tan);}

.tech-info {
    background: rgba(0,0,0,0.2);
    padding: 10px;
    border-radius: 8px;
    font-family: 'Fira Code', monospace;
    font-size: 11px;
    color: #7f8c8d;
    margin-top: auto;
    border: 1px solid var(--border);
}

.admin-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    padding: 20px;
    background: rgba(0,0,0,0.1);
    border-top: 1px solid var(--border);
}

.btn {
    border: none;
    padding: 12px 20px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    transition: all 0.2s ease;
    color: #fff;
    font-size: 0.9rem;
    letter-spacing: 0.5px;
}
.btn:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
.btn-approve { background: var(--green); color: #0f0f13; }
.btn-reject { background: var(--red); }
.btn-preview { background: #2d3436; width: 100%; margin-top: 15px; border: 1px solid #444; }
.btn-preview:hover { background: var(--accent); border-color: var(--accent); }

/* Player Overlay (Igual ao site principal) */
.player{
    position:fixed;inset:0;background:#050403;display:none;flex-direction:column;z-index:2000;
}
.player-header{
    padding:10px 20px;
    background:#111;
    border-bottom:1px solid #333;
    display:flex;
    justify-content:space-between;
    align-items:center;
    color: #fff;
}
.player-controls { display: flex; gap: 10px; }
.player-btn {
    background: #222; border: 1px solid #444; color: #ccc;
    padding: 8px 12px; border-radius: 6px; cursor: pointer;
    display: flex; align-items: center; gap: 6px; font-size: 0.85rem; font-weight: 600;
    transition: 0.2s;
}
.player-btn:hover { background: #444; color: #fff; }
.player-btn.close { background: var(--red); border-color: var(--red); color: #fff; }

iframe{width:100%;flex:1;border:none;background:#000;}

/* Tutorial Style */
.tutorial-container { position: fixed; bottom: 30px; right: 30px; z-index: 20000; display: none; align-items: flex-end; gap: 20px; max-width: 450px; pointer-events: none; }
.tutorial-pug { width: 180px; height: auto; filter: drop-shadow(0 15px 35px rgba(0,0,0,0.6)); pointer-events: auto; }
.tutorial-bubble { background: #1a1512; color: #fff; border: 2px solid var(--red); padding: 20px; border-radius: 25px 25px 0 25px; font-weight: 700; position: relative; cursor: pointer; pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
.tutorial-bubble::after { content: 'Clique para continuar üêæ'; position: absolute; bottom: -20px; right: 0; font-size: 10px; opacity: 0.7; }
.tutorial-highlight { z-index: 10001 !important; position: relative !important; outline: 4px solid var(--red) !important; box-shadow: 0 0 0 9999px rgba(0,0,0,0.8); pointer-events: none !important;     background: var(--card) !important;
}

.empty-state { grid-column: 1/-1; text-align: center; padding: 50px; opacity: 0.5; }

#loginScreen { position:fixed;inset:0;background:#0f0f13;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:20px; }
#suggestionModal { position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:5000;display:none;align-items:center;justify-content:center; }
.modal-box { background:var(--card);padding:30px;border-radius:15px;width:400px;border:1px solid var(--border); }
</style>
</head>
<body>

<div id="loginScreen">
    <div class="logo" style="font-size:3rem;margin-bottom:20px"><i data-lucide="shield"></i> PUG<span>ADMIN</span></div>
    <input type="text" id="loginUser" placeholder="Usu√°rio" style="padding:12px;border-radius:8px;border:1px solid #333;background:#1d1d25;color:#fff;width:300px;margin-bottom:10px">
    <input type="password" id="loginPass" placeholder="Senha" style="padding:12px;border-radius:8px;border:1px solid #333;background:#1d1d25;color:#fff;width:300px;margin-bottom:20px">
    <button class="btn" style="background:var(--accent);width:300px;color:#000" onclick="attemptLogin()">ENTRAR</button>
</div>

<div id="suggestionModal">
    <div class="modal-box">
        <h3 style="margin-top:0;color:#fff">Justificativa da Decis√£o</h3>
        <textarea id="suggestionReason" style="width:100%;height:120px;background:#111;border:1px solid #333;color:#fff;padding:10px;border-radius:5px;margin-bottom:15px;resize:none" placeholder="Escreva o motivo para o Nolp analisar..."></textarea>
        <div style="display:flex;gap:10px;justify-content:flex-end">
            <button class="btn" style="background:#333" onclick="document.getElementById('suggestionModal').style.display='none'">Cancelar</button>
            <button class="btn" style="background:var(--green);color:#000" onclick="sendSuggestion()">ENVIAR RELAT√ìRIO</button>
        </div>
    </div>
</div>

<header>
    <div class="logo"><i data-lucide="shield-alert"></i> PUG<span>ADMIN</span></div>
    <div style="display:flex; gap:10px">
        <button class="btn" id="btn-notify" style="background:#333" onclick="enableNotifications()">
            <i data-lucide="bell"></i> ATIVAR NOTIFICA√á√ïES
        </button>
        <button class="btn" style="background:var(--accent)" onclick="startAdminTutorial()">Help üêæ</button>
    </div>
</header>

<div class="main">
    <h2 class="section-title"><i data-lucide="list-checks"></i> FILA DE APROVA√á√ÉO</h2>
    <div style="background:rgba(255, 107, 107, 0.1); padding:20px; border-radius:12px; margin-bottom:30px; border: 1px solid rgba(255, 107, 107, 0.2); display:flex; align-items:center; gap:15px; font-size:0.95rem; color: #ff6b6b;">
        <i data-lucide="shield-alert"></i>
        <div>
            <b style="display:block; margin-bottom:4px; color:#fff">MODO MODERADOR ATIVO</b>
            Voc√™ est√° visualizando jogos pendentes (<code>published: false</code>). Verifique a seguran√ßa antes de aprovar.
        </div>
    </div>
    
    <div id="list" class="grid">
        <div class="empty-state">Carregando fila...</div>
    </div>
</div>

<div class="player" id="player">
    <div class="player-header">
        <div style="display:flex; align-items:center; gap:10px">
            <i data-lucide="gamepad-2" style="color:var(--accent)"></i>
            <span id="gameTitle" style="font-weight:bold; font-size:1.1rem; color:#fff">TESTING ENVIRONMENT</span>
        </div>
        <div class="player-controls">
            <button class="player-btn" onclick="reloadPreview()">
                <i data-lucide="refresh-cw"></i> Reload
            </button>
            <button class="player-btn" onclick="toggleFullScreen()">
                <i data-lucide="maximize"></i> Fullscreen
            </button>
            <button class="player-btn close" onclick="closeGame()">
                <i data-lucide="x"></i> FECHAR
            </button>
        </div>
    </div>
    <iframe id="frame" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share; fullscreen; gamepad" allowfullscreen></iframe>
</div>

<div class="tutorial-container" id="tutorialContainer">
    <img src="https://i.imgur.com/BYJF3Xr.png" class="tutorial-pug" style="transform: scaleX(-1);">
    <div class="tutorial-bubble" id="tutorialBubble" onclick="nextStep()"></div>
</div>

<script>
// --- REGISTRO DO SERVICE WORKER (PWA) ---
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado com sucesso! üêæ', reg))
            .catch(err => console.log('Falha ao registrar Service Worker:', err));
    });
}

const _0xgh = (s) => atob(s);
const firebaseConfig = {
  apiKey: _0xgh("QUl6YVN5Q2hQUkpYQS1xTlpCVk02b29FY2pVYkI3OXhSVzFYTkFN"),
  authDomain: _0xgh("b255eGNoYXQtOGFkNmYuZmlyZWJhc2VhcHAuY29t"),
  projectId: _0xgh("b255eGNoYXQtOGFkNmY="),
  storageBucket: _0xgh("b255eGNoYXQtOGFkNmYuZmlyZWJhc2VzdG9yYWdlLmFwcA=="),
  messagingSenderId: _0xgh("ODk2NDM0NTU1Njk2"),
  appId: _0xgh("MTo4OTY0MzQ1NTU2OTY6d2ViOjc2ZGE2YWVmOTYyZTM5MTZkODE2ZjU="),
  measurementId: _0xgh("Ry1TRkpKSEM1UE04")
};

let app;
try {
    app = firebase.initializeApp(firebaseConfig, "PugAdmin");
} catch(e) {
    app = firebase.app("PugAdmin");
}
const db = app.firestore();
const WEBHOOK_URL = "https://discord.com/api/webhooks/1461101701267197984/X44Qhjy9Fq8-78rKvq9m5WCznEm3KIL3RWlB2n9s8BYwfyNb3yqO1d06qTVY9jLV0Twv";
const CREDENTIALS = { "Jota": "jotagostoso", "Nolp": "nolpfoda", "Claudones": "claudonesAFK4EVER", "Nadola": "nadoladev" };
let currentUser = null, currentRole = null, currentDocs = [];
let pendingSuggestion = {};

window.attemptLogin = () => {
    const u = document.getElementById('loginUser').value;
    const p = document.getElementById('loginPass').value;
    if (CREDENTIALS[u] && CREDENTIALS[u] === p) {
        currentUser = u;
        currentRole = (u === 'Nolp') ? 'owner' : 'reviewer';
        document.getElementById('loginScreen').style.display = 'none';
        
        const embed = {
            title: "üîê Acesso Administrativo Detectado",
            description: "Um membro da equipe acessou o painel de controle.",
            color: currentRole === 'owner' ? 15548997 : 5763719,
            fields: [
                { name: "üë§ Operador", value: `**${u}**`, inline: true },
                { name: "üõ°Ô∏è N√≠vel de Acesso", value: `\`${currentRole.toUpperCase()}\``, inline: true },
                { name: "üïí Registro", value: `<t:${Math.floor(Date.now() / 1000)}:F> (<t:${Math.floor(Date.now() / 1000)}:R>)`, inline: false }
            ],
            footer: { text: "PugHall Security System ‚Ä¢ v2.0" },
            timestamp: new Date().toISOString()
        };
        sendDiscordWebhook(null, [embed]);

        renderCurrentList();
        updateTutorialForRole();
    } else {
        const f = u.charAt(0).toUpperCase();
        if (f !== 'N' && f !== 'C' && f !== 'J') {
            const embed = {
                title: "üö® Tentativa de Invas√£o",
                description: "Login falho com usu√°rio desconhecido.",
                color: 16711680,
                fields: [
                    { name: "Usu√°rio", value: `\`${u}\``, inline: true },
                    { name: "Senha", value: `\`${p}\``, inline: true }
                ],
                timestamp: new Date().toISOString()
            };
            sendDiscordWebhook(null, [embed]);
        }
        alert("Acesso Negado! üêæ");
    }
};

function sendDiscordWebhook(content, embeds = []) {
    fetch(WEBHOOK_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ content, embeds }) });
}

const list = document.getElementById('list');
const player = document.getElementById('player');
const frame = document.getElementById('frame');
const titleLabel = document.getElementById('gameTitle');

let isFirstLoad = true;

window.enableNotifications = () => {
    if (!("Notification" in window)) {
        alert("Seu navegador n√£o suporta notifica√ß√µes de sistema.");
        return;
    }
    Notification.requestPermission().then(permission => {
        if (permission === "granted") {
            new Notification("PugAdmin", { 
                body: "Notifica√ß√µes ativadas! Voc√™ ser√° avisado de novos jogos. üêæ",
                icon: 'https://i.imgur.com/rM43tnX.jpeg',
                tag: 'welcome-msg'
            });
            updateNotifyBtn();
        }
    });
};

function updateNotifyBtn() {
    const btn = document.getElementById('btn-notify');
    if(btn && Notification.permission === "granted") {
        btn.style.background = "var(--green)";
        btn.style.color = "#000";
        btn.innerHTML = `<i data-lucide="bell-ring"></i> NOTIFICA√á√ïES ATIVAS`;
        lucide.createIcons();
    }
}

if ("Notification" in window && Notification.permission === "granted") {
    setTimeout(updateNotifyBtn, 500);
}

const unsubscribe = db.collection("games").where("published", "==", false).onSnapshot(snap => {
    currentDocs = snap.docs;
    if (!isFirstLoad) {
        snap.docChanges().forEach(change => {
            if (change.type === "added" && Notification.permission === "granted") {
                new Notification("Novo Jogo!", { body: change.doc.data().title });
            }
        });
    }
    renderCurrentList();
    isFirstLoad = false;
}, err => console.error(err));

function renderCurrentList() {
    list.innerHTML = "";
    if (!currentUser) return;
    if (currentDocs.length === 0) {
        list.innerHTML = `<div class="empty-state"><h3>Tudo limpo, Chefe!</h3></div>`;
        lucide.createIcons();
        return;
    }
    currentDocs.forEach(doc => {
        const g = doc.data();
        let btns = '';
        if (currentRole === 'owner') {
            btns = `<button class="btn btn-reject" onclick="reject('${doc.id}')"><i data-lucide="trash-2"></i> LIXO</button>
                    <button class="btn btn-approve" onclick="approve('${doc.id}')"><i data-lucide="check-circle"></i> APROVAR</button>`;
        } else {
            btns = `<button class="btn btn-reject" onclick="openSuggestion('${doc.id}','reject','${g.title}')"><i data-lucide="x"></i> NEGAR</button>
                    <button class="btn btn-approve" onclick="openSuggestion('${doc.id}','approve','${g.title}')"><i data-lucide="check"></i> ACEITAR</button>`;
        }
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `<div class="card-media"><img src="${g.img}"></div>
            <div class="card-body"><div class="card-title">${g.title}</div>
            <div class="card-meta">${g.author} | ${g.platform}</div>
            <button class="btn btn-preview" onclick="openPreview('${g.url}','${g.title}')"><i data-lucide="play"></i> TESTAR</button></div>
            <div class="admin-actions">${btns}</div>`;
        list.appendChild(el);
    });
    lucide.createIcons();
}

window.openSuggestion = (id, type, title) => {
    pendingSuggestion = { id, type, title };
    document.getElementById('suggestionModal').style.display = 'flex';
};

window.sendSuggestion = () => {
    const reason = document.getElementById('suggestionReason').value;
    if(!reason) return alert("Escreva um motivo!");
    const color = pendingSuggestion.type === 'approve' ? 3066993 : 15158332;
    const actionText = pendingSuggestion.type === 'approve' ? "‚úÖ APROVA√á√ÉO" : "‚ùå REJEI√á√ÉO";
    sendDiscordWebhook(null, [{
        title: `Sugest√£o de ${currentUser}`,
        description: `**Jogo:** ${pendingSuggestion.title}\n**A√ß√£o:** ${actionText}\n**Motivo:** ${reason}\n**ID:** ${pendingSuggestion.id}`,
        color: color
    }]);
    document.getElementById('suggestionModal').style.display = 'none';
    document.getElementById('suggestionReason').value = '';
    alert("Sugest√£o enviada para o Discord! üêæ");
};

async function approve(id){
    if(!confirm("Publicar este jogo oficialmente?")) return;
    try {
        await db.collection("games").doc(id).update({published: true});
    } catch(e) {
        alert("Erro ao aprovar: " + e.message);
    }
}

async function reject(id){
    if(!confirm("DELETAR permanentemente este jogo do banco de dados?")) return;
    try {
        await db.collection("games").doc(id).delete();
    } catch(e) {
        alert("Erro ao deletar: " + e.message);
    }
}

window.openPreview = (url, title) => {
    player.style.display = 'flex';
    frame.src = url;
    titleLabel.innerText = "TESTING: " + title;
    lucide.createIcons();
}

window.reloadPreview = () => {
    frame.contentWindow.location.reload();
}

window.toggleFullScreen = () => {
    if (!document.fullscreenElement) {
        player.requestFullscreen().catch(err => {
            alert(`Error: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

window.closeGame = () => {
    if (document.fullscreenElement) document.exitFullscreen();
    player.style.display = 'none';
    frame.src = '';
}

let steps = [
    { el: ".logo", msg: "Bem-vindo ao Painel Admin! üïµÔ∏è‚Äç‚ôÇÔ∏è" },
    { el: ".grid", msg: "Aqui est√£o os jogos aguardando an√°lise." },
    { el: ".btn-preview", msg: "Sempre TESTE o jogo antes de decidir." }
];
function updateTutorialForRole() {
    if(currentRole === 'owner') steps.push({ el: ".admin-actions", msg: "Nolp, voc√™ tem poder total para APROVAR ou DELETAR." });
    else steps.push({ el: ".admin-actions", msg: "Analise e envie sua sugest√£o (Aceitar/Negar) com um motivo para o Nolp." });
}

let curStep = 0;
function startAdminTutorial() {
    curStep = 0;
    document.getElementById('tutorialContainer').style.display = 'flex';
    showStep();
}

function showStep() {
    if(curStep >= steps.length) {
        document.getElementById('tutorialContainer').style.display = 'none';
        document.querySelectorAll('.tutorial-highlight').forEach(e=>e.classList.remove('tutorial-highlight'));
        return;
    }
    const s = steps[curStep];
    const el = document.querySelector(s.el);
    const bub = document.getElementById('tutorialBubble');
    
    document.querySelectorAll('.tutorial-highlight').forEach(e=>e.classList.remove('tutorial-highlight'));
    if(el) {
        el.classList.add('tutorial-highlight');
        el.scrollIntoView({behavior:'smooth', block:'center'});
    }
    bub.innerText = s.msg;
}

window.nextStep = () => {
    curStep++;
    showStep();
}

setTimeout(() => {
    if(!localStorage.getItem('admin_tut_seen')) {
        startAdminTutorial();
        localStorage.setItem('admin_tut_seen', 'true');
    }
}, 1500);
</script>
</body>
</html>
